<%- include("../../views/partials/user/userHeader")%>

<style>
    .default-address-card .card {
        border: 1px solid #000000;
        border-radius: 1px;
    }
    
    .default-address-card .card-body {
        padding: 20px;
    }
    
    .address-actions .btn-link {
       
        color: #000000;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
       
       
    }

   
    
    .address-actions .btn-link:hover {
        background-color: #000000;
        color: #ffffff;
    }
    
    #savedAddresses {
        border: 1px solid #ebebeb;
        height: 46px;
        padding: 0 15px;
        color: #666666;
    }
    
    .btn-outline-dark {
        border-color: #111111;
        color: #111111;
    }
    
    .btn-outline-dark:hover {
        background-color: #111111;
        color: #ffffff;
    }
    
    .modal-content {
        border-radius: 4px;
    }
    
    .modal-header {
        border-bottom: 1px solid #ebebeb;
        background-color: #f8f9fa;
    }
    
    .modal-footer {
        border-top: 1px solid #ebebeb;
    }
    
    .form-control {
        height: 46px;
        border: 1px solid #ebebeb;
        border-radius: 4px;
        padding: 0 15px;
    }
    
    .form-control:focus {
        border-color: #111111;
        box-shadow: none;
    }
    
    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #111111;
        border-color: #111111;
    }
</style>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Checkout</h4>
                    <div class="breadcrumb__links">
                        <a href="/">Home</a>
                        <a href="/shop">Shop</a>
                        <a href="/cart">Shopping Cart</a>
                        <span>Checkout</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!-- Checkout Section Begin -->
<section class="checkout spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="checkout__form">
                    <h6 class="checkout__title">Shipping Address</h6>
                    
                    <!-- Default Address Card -->
                    <div class="default-address-card mb-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="card-subtitle text-muted">Default Address</h6>
                                    <div class="address-actions">
                                        <button class="btn btn-link p-1" type="button" data-toggle="collapse" data-target="#addressSelect">
                                            Change
                                        </button>
                                    </div>
                                </div>
                                <h5 class="card-title"><%= defaultAddress.name %></h5>
                                <p class="card-text">
                                    <%= defaultAddress.street %><br>
                                    <%= defaultAddress.city %>, <%= defaultAddress.state %><br>
                                    <%= defaultAddress.zipCode %><br>
                                    Phone: <%= defaultAddress.phone %>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Address Selection Dropdown -->
                    <div class="collapse" id="addressSelect">
                        <div class="card card-body mb-4">
                            <h6 class="mb-3">Select Different Address</h6>
                            <select class="form-control" id="savedAddresses">
                                <option value="">Choose from saved addresses</option>
                                <% savedAddresses.forEach(address => { %>
                                    <option value="<%= address._id %>">
                                        <%= address.name %> - <%= address.street %>, <%= address.city %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                    </div>

                    <!-- Add New Address Button -->
                    <div class="text-right mb-4">
                        <button type="button" class="btn btn-outline-dark" data-toggle="modal" data-target="#addAddressModal">
                            + Add New Address
                        </button>
                    </div>
                </div>
            </div>

            <!-- Order Summary Column -->
            <div class="col-lg-4">
                <div class="checkout__order">
                    <h6 class="order__title">Your order</h6>
                    <div class="checkout__order__products">Products <span>Total</span></div>
                    <ul class="checkout__total__products">
                        <% cart.items.forEach(item => { %>
                        <li><%= item.productId.productName %> × <%= item.quantity %> <span>₹<%= item.totalPrice %></span></li>
                        <% }); %>
                    </ul>
                    <ul class="checkout__total__all">
                        <li>Subtotal <span>₹<%= cart.totalPrice %></span></li>
                        <% if (cart.discount) { %>
                        <li>Discount <span>-₹<%= cart.discount %></span></li>
                        <% } %>
                        <li>Total <span>₹<%= cart.totalPrice - (cart.discount || 0) %></span></li>
                    </ul>
                    <div class="checkout__input__checkbox">
                        <label for="payment">
                            Cash on Delivery
                            <input type="checkbox" id="payment" name="paymentMethod" value="cod">
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <div class="checkout__input__checkbox">
                        <label for="online">
                            Online Payment
                            <input type="checkbox" id="online" name="paymentMethod" value="online">
                            <span class="checkmark"></span>
                        </label>
                    </div>
                    <button type="submit" class="site-btn">PLACE ORDER</button>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" role="dialog" aria-labelledby="addAddressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="newAddressForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Full Name<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Phone Number<span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" name="phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Street Address<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="street" required>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>City<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="city" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>State<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="state" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>ZIP Code<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="zipCode" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="makeDefault" name="makeDefault">
                            <label class="custom-control-label" for="makeDefault">Make this my default address</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAddress">Save Address</button>
            </div>
        </div>
    </div>
</div>


<div id="alertContainer"></div>

<script>
    $(document).ready(function() {
        // Handle address selection change
        $('#savedAddresses').change(function() {
            const selectedAddressId = $(this).val();
            if (selectedAddressId) {
                // Make AJAX call to get address details and update the display
                $.ajax({
                    url: `/api/addresses/${selectedAddressId}`,
                    method: 'GET',
                    success: function(response) {
                        updateDisplayedAddress(response.address);
                    },
                    error: function(error) {
                        showAlert('Error loading address details', 'danger');
                    }
                });
            }
        });
    
        // Handle new address submission
        $('#saveAddress').click(function() {
            const formData = $('#newAddressForm').serialize();
            
            $.ajax({
                url: '/api/addresses',
                method: 'POST',
                data: formData,
                success: function(response) {
                    $('#addAddressModal').modal('hide');
                    showAlert('Address added successfully', 'success');
                    // Refresh the page or update the address list
                    location.reload();
                },
                error: function(error) {
                    showAlert('Error saving address', 'danger');
                }
            });
        });
    
        // Function to update displayed address
        function updateDisplayedAddress(address) {
            const addressHtml = `
                <h5 class="card-title">${address.name}</h5>
                <p class="card-text">
                    ${address.street}<br>
                    ${address.city}, ${address.state}<br>
                    ${address.zipCode}<br>
                    Phone: ${address.phone}
                </p>
            `;
            $('.default-address-card .card-body').html(addressHtml);
            $('#addressSelect').collapse('hide');
        }
    
        // Function to show alerts
        function showAlert(message, type) {
            const alert = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            `;
            $('#alertContainer').html(alert);
        }
    });
</script>


<%- include("../../views/partials/user/userFooter")%>


